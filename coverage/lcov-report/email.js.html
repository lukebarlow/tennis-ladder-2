<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for email.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="prettify.css" />
    <link rel="stylesheet" href="base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="index.html">All files</a> email.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">2.42% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>3/124</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/71</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/26</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">2.61% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>3/115</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var nodemailer = require('nodemailer')
&nbsp;
var config = require('./config')
&nbsp;
module.exports = {
  sendEmailsAboutChallenge: sendEmailsAboutChallenge,
  sendEmailsAboutMatch: sendEmailsAboutMatch,
  sendTestEmail: sendTestEmail,
  sendInvitationEmails: sendInvitationEmails
}
&nbsp;
var transport
&nbsp;
// lazy building of the transport object
function <span class="fstat-no" title="function not covered" >getTransport </span>() {
<span class="cstat-no" title="statement not covered" >  if (!transport) {</span>
<span class="cstat-no" title="statement not covered" >    transport = nodemailer.createTransport('SMTP', {</span>
      service: 'Gmail',
      auth: {
        user: config.email.user,
        pass: config.email.password
      }
    })
  }
<span class="cstat-no" title="statement not covered" >  return transport</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >closeTransport </span>() {
<span class="cstat-no" title="statement not covered" >  if (transport) <span class="cstat-no" title="statement not covered" >transport.close()</span></span>
<span class="cstat-no" title="statement not covered" >  transport = null</span>
}
&nbsp;
// figures out which players need an email about a new challenge, and sends
// that email. Challenger and challenged arguments should be ObjectIds of
// the players involved in the challenge
function <span class="fstat-no" title="function not covered" >sendEmailsAboutChallenge </span>(challengerId, challengedId, callback) {
  var db = <span class="cstat-no" title="statement not covered" >require('./getDb')</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  db.getPlayers(<span class="fstat-no" title="function not covered" >fu</span>nction (error, players) {</span>
    var challenger, challenged
<span class="cstat-no" title="statement not covered" >    players.forEach(<span class="fstat-no" title="function not covered" >fu</span>nction (player) {</span>
<span class="cstat-no" title="statement not covered" >      if (player._id.equals(challengerId)) {</span>
<span class="cstat-no" title="statement not covered" >        challenger = player</span>
      }
<span class="cstat-no" title="statement not covered" >      if (player._id.equals(challengedId)) {</span>
<span class="cstat-no" title="statement not covered" >        challenged = player</span>
      }
    })
&nbsp;
    var emailsSent = <span class="cstat-no" title="statement not covered" >0</span>
&nbsp;
    var callbacksCounted = <span class="cstat-no" title="statement not covered" >0</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    players.forEach(<span class="fstat-no" title="function not covered" >fu</span>nction (player, i) {</span>
<span class="cstat-no" title="statement not covered" >      player.settings = player.settings || {}</span>
      // player gets an email if they're involved in the challenge and
      // have 'emailMyChallenge' preference, or they have 'emailAnyChallenge'
&nbsp;
      var isChallenger = <span class="cstat-no" title="statement not covered" >player._id.equals(challengerId)</span>
&nbsp;
      var isChallenged = <span class="cstat-no" title="statement not covered" >player._id.equals(challengedId)</span>
&nbsp;
      var isParticipant = <span class="cstat-no" title="statement not covered" >isChallenger || isChallenged</span>
<span class="cstat-no" title="statement not covered" >      replyTo = null</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >      if ((player.settings.emailMyChallenge &amp;&amp; isParticipant) || player.settings.emailAnyChallenge) {</span>
<span class="cstat-no" title="statement not covered" >        emailsSent++</span>
<span class="cstat-no" title="statement not covered" >        sendChallenge(player, challenger, challenged, isParticipant, <span class="fstat-no" title="function not covered" >fu</span>nction () {</span>
<span class="cstat-no" title="statement not covered" >          callbacksCounted++</span>
<span class="cstat-no" title="statement not covered" >          if (callbacksCounted &gt;= emailsSent) {</span>
<span class="cstat-no" title="statement not covered" >            console.log('all emails sent')</span>
<span class="cstat-no" title="statement not covered" >            closeTransport()</span>
<span class="cstat-no" title="statement not covered" >            if (callback) <span class="cstat-no" title="statement not covered" >callback()</span></span>
          };
        })
      }
    })
  })
}
&nbsp;
function <span class="fstat-no" title="function not covered" >sendInvitationEmails </span>(invitation, callback) {
  var db = <span class="cstat-no" title="statement not covered" >require('./getDb')</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  db.getPlayer({ _id: invitation.inviter }, <span class="fstat-no" title="function not covered" >fu</span>nction (error, inviter) {</span>
<span class="cstat-no" title="statement not covered" >    db.getPlayer({ _id: invitation.invited }, <span class="fstat-no" title="function not covered" >fu</span>nction (error, invited) {</span>
      var sent = <span class="cstat-no" title="statement not covered" >0</span>
      function <span class="fstat-no" title="function not covered" >sentHandler </span>(error, result) {
<span class="cstat-no" title="statement not covered" >        if (error) {</span>
<span class="cstat-no" title="statement not covered" >          console.log('EMAIL ERROR!')</span>
<span class="cstat-no" title="statement not covered" >          console.log(error)</span>
        }
<span class="cstat-no" title="statement not covered" >        sent++</span>
<span class="cstat-no" title="statement not covered" >        if (sent &gt;= 2 &amp;&amp; callback) {</span>
<span class="cstat-no" title="statement not covered" >          callback()</span>
        }
      }
&nbsp;
      // the email to the invited
      var emailDetails = <span class="cstat-no" title="statement not covered" >{</span>
        from: config.email.user,
        to: invited.settings.email,
        replyTo: inviter.settings.email,
        subject: config.siteName + ' : ' + inviter.name + ' has invited you to play',
        text: ' ',
        html: invitationBody(invited, inviter)
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      getTransport().sendMail(emailDetails, sentHandler)</span>
&nbsp;
      // email to the inviter
      var emailDetails = <span class="cstat-no" title="statement not covered" >{</span>
        from: config.email.user,
        to: inviter.settings.email,
        replyTo: invited.settings.email,
        subject: config.siteName + ' : You have invited ' + invited.name + ' to play',
        text: ' ',
        html: invitationBody(inviter, invited)
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      getTransport().sendMail(emailDetails, sentHandler)</span>
    })
  })
}
&nbsp;
function <span class="fstat-no" title="function not covered" >sendEmailsAboutMatch </span>(match, callback) {
  var db = <span class="cstat-no" title="statement not covered" >require('./getDb')</span>
<span class="cstat-no" title="statement not covered" >  db.getPlayers(<span class="fstat-no" title="function not covered" >fu</span>nction (error, players) {</span>
    var emailsSent = <span class="cstat-no" title="statement not covered" >0</span>
&nbsp;
    var callbacksCounted = <span class="cstat-no" title="statement not covered" >0</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    players.forEach(<span class="fstat-no" title="function not covered" >fu</span>nction (player, i) {</span>
<span class="cstat-no" title="statement not covered" >      player.settings = player.settings || {}</span>
      // player gets an email if they're involved in the challenge and
      // have 'emailMyChallenge' preference, or they have 'emailAnyChallenge'
<span class="cstat-no" title="statement not covered" >      if ((player.settings.emailMyMatch &amp;&amp; (player._id.equals(match.playerA._id) || player._id.equals(match.playerB._id))) ||</span>
          player.settings.emailAnyMatch) {
<span class="cstat-no" title="statement not covered" >        emailsSent++</span>
<span class="cstat-no" title="statement not covered" >        sendMatchReport(player, match, <span class="fstat-no" title="function not covered" >fu</span>nction () {</span>
<span class="cstat-no" title="statement not covered" >          callbacksCounted++</span>
<span class="cstat-no" title="statement not covered" >          if (callbacksCounted &gt;= emailsSent) {</span>
<span class="cstat-no" title="statement not covered" >            console.log('all emails sent')</span>
<span class="cstat-no" title="statement not covered" >            closeTransport()</span>
<span class="cstat-no" title="statement not covered" >            if (callback) <span class="cstat-no" title="statement not covered" >callback()</span></span>
          }
        })
      }
    })
  })
}
&nbsp;
// challenger and challenged are names Player is the whole dict of the player
// we want to send the email to
function <span class="fstat-no" title="function not covered" >sendChallenge </span>(player, challenger, challenged, isParticipant, callback) {
<span class="cstat-no" title="statement not covered" >  if (!player.settings.email) {</span>
<span class="cstat-no" title="statement not covered" >    console.log('No email address, so cannot send challenge to ' + player.name)</span>
<span class="cstat-no" title="statement not covered" >    console.log(player)</span>
<span class="cstat-no" title="statement not covered" >    if (callback) <span class="cstat-no" title="statement not covered" >callback('No email')</span></span>
<span class="cstat-no" title="statement not covered" >    return</span>
  }
&nbsp;
  var replyTo
&nbsp;
  var isChallenger = <span class="cstat-no" title="statement not covered" >player._id == challenger._id</span>
&nbsp;
  // if you're in the game, then the reply to will reply to the opponent
<span class="cstat-no" title="statement not covered" >  if (isParticipant) {</span>
<span class="cstat-no" title="statement not covered" >    replyTo = isChallenger ? challenged.settings.email : challenger.settings.email</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  console.log('sending an email to ' + player.name + '(' + player.settings.email + ')')</span>
<span class="cstat-no" title="statement not covered" >  console.log(challenger.name + ' challenged ' + challenged.name)</span>
&nbsp;
  var emailDetails = <span class="cstat-no" title="statement not covered" >{</span>
    from: config.email.user,
    to: player.settings.email,
    subject: config.siteName + ' : ' + challenger.name + ' challenged ' + challenged.name,
    text: ' ',
    html: isParticipant
      ? challengeEmailBody(isChallenger ? challenged : challenger, replyTo)
      : body()
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (replyTo) <span class="cstat-no" title="statement not covered" >emailDetails.replyTo = replyTo</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  getTransport().sendMail(emailDetails, <span class="fstat-no" title="function not covered" >fu</span>nction (error, result) {</span>
<span class="cstat-no" title="statement not covered" >    if (error) {</span>
<span class="cstat-no" title="statement not covered" >      console.log('EMAIL ERROR!')</span>
<span class="cstat-no" title="statement not covered" >      console.log(error)</span>
    } else {
<span class="cstat-no" title="statement not covered" >      console.log('email result', result)</span>
<span class="cstat-no" title="statement not covered" >      if (callback) <span class="cstat-no" title="statement not covered" >callback()</span></span>
    }
  })
}
&nbsp;
function <span class="fstat-no" title="function not covered" >invitationBody </span>(me, opponent) {
<span class="cstat-no" title="statement not covered" >  html = '&lt;br /&gt;&lt;b&gt;' + me.name + '&lt;/b&gt;&lt;br /&gt;'</span>
<span class="cstat-no" title="statement not covered" >  html += contactDetailsHtml(me)</span>
<span class="cstat-no" title="statement not covered" >  html += '&lt;br /&gt;&lt;b&gt;' + opponent.name + '&lt;/b&gt;&lt;br /&gt;'</span>
<span class="cstat-no" title="statement not covered" >  html += contactDetailsHtml(opponent)</span>
<span class="cstat-no" title="statement not covered" >  html += '&lt;br&gt;&lt;br&gt;'</span>
<span class="cstat-no" title="statement not covered" >  html += 'Hit reply to email ' + opponent.name</span>
<span class="cstat-no" title="statement not covered" >  return html</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >challengeEmailBody </span>(opponent, includeReplyMessage) {
  var html = <span class="cstat-no" title="statement not covered" >'&lt;html&gt;&lt;body&gt;&lt;a href="http://' + config.domainName + '"&gt;' + config.domainName + '&lt;/a&gt;&lt;br /&gt;'</span>
<span class="cstat-no" title="statement not covered" >  html += '&lt;br /&gt;&lt;b&gt;' + opponent.name + '&lt;/b&gt;&lt;br /&gt;'</span>
<span class="cstat-no" title="statement not covered" >  html += contactDetailsHtml(opponent)</span>
<span class="cstat-no" title="statement not covered" >  if (includeReplyMessage) <span class="cstat-no" title="statement not covered" >html += '&lt;br &gt;&lt;br /&gt;Hit reply to email ' + opponent.name + '.'</span></span>
<span class="cstat-no" title="statement not covered" >  html += '&lt;/body&gt;&lt;/html&gt;'</span>
<span class="cstat-no" title="statement not covered" >  return html</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >contactDetailsHtml </span>(player) {
  var html = <span class="cstat-no" title="statement not covered" >''</span>
<span class="cstat-no" title="statement not covered" >  if (player.settings.email) {</span>
<span class="cstat-no" title="statement not covered" >    html += 'email : ' + player.settings.email + '&lt;br /&gt;'</span>
  }
<span class="cstat-no" title="statement not covered" >  if (player.settings.phoneNumber) {</span>
<span class="cstat-no" title="statement not covered" >    html += 'phone number : ' + player.settings.phoneNumber + '&lt;br /&gt;'</span>
  }
<span class="cstat-no" title="statement not covered" >  return html</span>
}
&nbsp;
// converts a match to a string
function <span class="fstat-no" title="function not covered" >matchString </span>(match) {
  var score = <span class="cstat-no" title="statement not covered" >match.score.map(<span class="fstat-no" title="function not covered" >fu</span>nction (match) { <span class="cstat-no" title="statement not covered" >return match[0] + '-' + match[1] </span>}).join(', ')</span>
<span class="cstat-no" title="statement not covered" >  return match.playerA.name + ' v ' + match.playerB.name + ' : ' + score</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >sendMatchReport </span>(player, match, callback) {
<span class="cstat-no" title="statement not covered" >  console.log('emailing turned off for now')</span>
<span class="cstat-no" title="statement not covered" >  return</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (!player.settings.email) {</span>
<span class="cstat-no" title="statement not covered" >    console.log('No email address, so cannot send match report to ' + player.name)</span>
<span class="cstat-no" title="statement not covered" >    console.log(player)</span>
<span class="cstat-no" title="statement not covered" >    if (callback) <span class="cstat-no" title="statement not covered" >callback('No email')</span></span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  console.log('sending a match report to ' + player.name)</span>
<span class="cstat-no" title="statement not covered" >  console.log(match)</span>
&nbsp;
  var emailDetails = <span class="cstat-no" title="statement not covered" >{</span>
    from: config.email.user,
    to: player.settings.email,
    subject: config.siteName + ' : ' + matchString(match),
    text: ' ',
    html: body()
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  getTransport().sendMail(emailDetails, callback)</span>
}
&nbsp;
// just for testing the SMTP is all working
function <span class="fstat-no" title="function not covered" >sendTestEmail </span>(to, subject, message) {
  var emailDetails = <span class="cstat-no" title="statement not covered" >{</span>
    from: config.email.user,
    to: to,
    subject: subject || 'test email from tenn16.co.uk',
    text: message || 'test'
  }
<span class="cstat-no" title="statement not covered" >  getTransport().sendMail(emailDetails, <span class="fstat-no" title="function not covered" >fu</span>nction (error, result) {</span>
<span class="cstat-no" title="statement not covered" >    console.log('----- error ------')</span>
<span class="cstat-no" title="statement not covered" >    console.log(error)</span>
<span class="cstat-no" title="statement not covered" >    console.log('------result ------')</span>
<span class="cstat-no" title="statement not covered" >    console.log(result)</span>
  })
}
&nbsp;
function <span class="fstat-no" title="function not covered" >body </span>() {
<span class="cstat-no" title="statement not covered" >  return '&lt;html&gt;&lt;body&gt;&lt;a href="http://' + config.domainName + '"&gt;' + config.domainName + '&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;'</span>
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Thu Nov 01 2018 21:29:53 GMT+0000 (GMT)
</div>
</div>
<script src="prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="sorter.js"></script>
</body>
</html>
